{% extends 'annotationapp/annotationapp_base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
{% block title %} {{ sound.filename }} annotation page {% endblock %}
{% block extra_head %}
<style>
  .waveform-visualiser-container:not(.last) .overview-container{
    display: none;
  }
</style>
{% endblock %}

{% block links %}
    <div class="form-group">
      <div class="col-xs-1">
        <form action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <p>{{ form }} </p>
        <p><input type="submit" value="Create tier" /></p>
        </form>
      </div>
    </div>
{% endblock %}

{% block content %}

  <script src="{% static 'node_modules/peaks.js/peaks.js' %}"></script>
  <div id="titles">

    <div class="ref-sound">
    <div>
        <h4> Reference sound <small> {{ sound.exercise.reference_sound.filename }} </small></h4>
    </div>
       <div id="audio-ref-controls">
        <audio controls=controls>
          <source src="{{ MEDIA_URL }}{{ sound.exercise.reference_sound.filename }}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
       </div>
     </div>
    <div>
        <h4> {{ sound.filename }} </h4>
    </div>
    {% for tier in sound.exercise.tiers.all %}
    <div>
        <h5>tier: {{ tier.name }}</h5>
    </div>
     <div class='tier reference'
        data-tier-id='{{tier.id}}'
        data-action-url='{% url "annotation-action" sound.exercise.reference_sound.id tier.id %}'
        data-audio="audio-ref-controls"
        data-annotations-url='{% url "get-annotations" sound.exercise.reference_sound.id tier.id %}'
        data-waveform='{{ MEDIA_URL }}{{sound.exercise.reference_sound.waveform_data }}' >
     <div class="waveform-visualiser-container"></div>
    </div>
    <div class='tier'
          data-tier-id='{{tier.id}}'
          data-action-url='{% url "annotation-action" sound.id tier.id %}'
          data-audio='audio-controls'
          data-annotations-url='{% url "get-annotations" sound.id tier.id %}'
          data-action-url='{% url "annotation-action" sound.id tier.id %}'
          data-waveform='{{ MEDIA_URL }}{{sound.waveform_data }}'>
      <div class="waveform-visualiser-container"></div>
      {% if not tier.entire_sound %}
        <button class="add-segment">Add a Segment to Tier</button>
        <button class="remove-point">Remove Segment</button>
      {% else %}
        <button class="add-simil-segment">Add a Similarity Segment</button>
      {% endif %}
      <button class="remove-point">Remove Segment</button>
      <input class="name-txt" type="text" />
    </div>
    {% endfor %}

    <div id="audio-controls">
      <audio controls=controls>
        <source src="{{ MEDIA_URL }}{{ sound.filename }}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    </div>
  </div>

      <script>
        var tempId = 0;
        function getTempId(){ return tempId++;}
        // function to generate random colors
        function g() {
          return Math.floor(Math.random() * 255);
        }
        function callServer(action, segment, url, cb){
          var xhr = new XMLHttpRequest();
          xhr.responseType = 'json';
          xhr.onreadystatechange = function() {
              if (xhr.readyState == XMLHttpRequest.DONE ) {
                 if (xhr.status == 200) {
                     cb(xhr.response);
                 }
                 else if (xhr.status == 400) {
                    alert('There was an error 400');
                 }
              }
          };

          xhr.open("POST", url, true);
          data = segment;
          data.action = action;
          xhr.send(JSON.stringify(data));
        }
        function getAnnotations(theUrl){
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
            xmlHttp.send( null );
            return JSON.parse(xmlHttp.responseText);
        }
        var delayedEdit = [];
        var delayedTextEdit = [];
        var reference = {};
        var reference_colors = {};
        (function(Peaks){
          var tiers = document.getElementsByClassName('tier');
          for (var i = 0; i < tiers.length; i++) {
            var container = tiers[i];
            var url = container.getAttribute('data-action-url');
            var urlAnnotations = container.getAttribute('data-annotations-url');

            // parameters to create new waveform for annotation tier
            var options = {
              container: container.getElementsByClassName('waveform-visualiser-container')[0],
              mediaElement: document.querySelector("#"+container.getAttribute('data-audio')).querySelector('audio'),
              dataUri: {
                arraybuffer: container.getAttribute('data-waveform'),
              },
              height: 120,
              keyboard: false,
              segments: []
            };


            var rsp = getAnnotations(urlAnnotations);
            if (rsp.status == 'success') {
              var tId = container.getAttribute('data-tier-id')
              for (var j = 0; j < rsp.annotations.length; j++){
                var segment = {
                  id: rsp.annotations[j].annotation_id,
                  startTime: rsp.annotations[j].startTime,
                  endTime: rsp.annotations[j].endTime,
                  labelText: rsp.annotations[j].name,
                  editable: true,
                  color: 'rgba(' + g() + ', ' + g() + ', ' + g() + ', 1)'
                }
                
                if (container.classList.contains('reference')) {
                  if  (!(tId in reference_colors)) {
                    reference_colors[tId] = {};
                  }
                  reference_colors[tId][rsp.annotations[j].annotation_id] = segment['color']; 
                }
                if (rsp.annotations[j].referenceId != null) {
                    segment['color'] = reference_colors[tId][rsp.annotations[j].referenceId]; 
                    segment['referenceId'] = rsp.annotations[j].referenceId; 
                }
                options.segments.push(segment);
              }
            }
            // instantiate Peaks.js annotator
            var peaksInstance = Peaks.init(options);
            
            peaksInstance.on('user_seek.*', (function(container, tier){
              return function(currTime){
                var tId = container.getAttribute('data-tier-id')
                var segments = tier.segments.getSegments();
                var shown = false;
                for (var i = 0; i < segments.length; i++) {
                  if (currTime >= segments[i].startTime && currTime <= segments[i].endTime){
                      var inp = container.querySelectorAll(".name-txt");
                      if (inp.length > 0) {
                        inp[0].value = segments[i].labelText;
                      }
                      container.setAttribute("data-selected", segments[i].id);
                      shown = true;
                      // If we are in a reference tier, then save the object to access from the events of the other element
                      if (container.classList.contains('reference')) {
                        reference[tId] = segments[i];
                      }
                  }
                }
                if (!shown) {
                    var inp = container.querySelectorAll(".name-txt");
                    if (inp.length > 0) {
                      inp[0].value = '';
                    }
                    container.setAttribute("data-selected", null);
                    // If we are in a reference tier, then reset the saved element
                    if (container.classList.contains('reference')) {
                      reference[tId] = null;
                    }
                }
              }
            })(container, peaksInstance));

            // By ajax update data of edited segment annotation
            peaksInstance.on('segments.dragged', function(segment){
              segment.annotation_id = segment.id;
              for (var i = 0; i < delayedEdit.length; i++) {
                window.clearTimeout(delayedEdit[i]);
                delayedEdit.splice(i, 1);
              }
              delayedEdit.push(setTimeout(function(){
                  callServer('edit', segment, url, function(response){});
              }, 1000));

            });

            // Add new similarity segment to the current tier, also store the annotation in the database
            var addBtn = container.querySelectorAll(".add-simil-segment");
            if (addBtn.length > 0) {
              addBtn[0].addEventListener("click", function (container, tier, actionUrl) {
                return function(){
                  var tId = container.getAttribute('data-tier-id')
                  var otherSegment = reference[tId];
                  var has_reference = false;
                  var segments = tier.segments.getSegments();
                  if (otherSegment != null){
                    for (var i = 0; i< segments.length; i++){
                      if (segments[i].referenceId == otherSegment.id) {
                        has_reference = true;
                      }
                    }
                    if (!has_reference){
                      var startTime = otherSegment.startTime;
                      var endTime = otherSegment.endTime;
                      var auxId = getTempId();
                      var segment = {
                        startTime: startTime,
                        endTime: endTime,
                        editable: true,
                        id: auxId,
                        referenceId: otherSegment.id,
                        color: otherSegment.color
                      };
                      tier.segments.add(segment);
                      callServer('add', segment, actionUrl, function(response){
                        if (response.status == 'success'){
                          var segments = tier.segments.getSegments();
                          for (var i = 0; i< segments.length; i++){
                            if (segments[i].id == auxId){
                              segments[i].id = response.annotation_id;
                              segments[i].referenceId = otherSegment.id;
                              container.setAttribute("data-selected", segments[i].id);
                            }
                          }
                        }
                      });
                    }
                  }
                }
              }(container, peaksInstance, url));
            }


            // Add new segment to the current tier, also store the annotation in the database
            var addBtn = container.querySelectorAll(".add-segment");
            if (addBtn.length > 0) {
              addBtn[0].addEventListener("click", function (tier, actionUrl) {
                return function(){
                  var currTime = tier.time.getCurrentTime()
                  var segments = tier.segments.getSegments();
                  for (var i = 0; i < segments.length; i++) {
                    if (currTime >= segments[i].startTime && currTime <= segments[i].endTime){
                      currTime = segments[i].endTime;
                    }
                  }
                  var auxId = getTempId();
                  var segment = {
                    startTime: currTime,
                    endTime: currTime + 1,
                    editable: true,
                    id: auxId
                  };
                  tier.segments.add(segment);
                  callServer('add', segment, actionUrl, function(response){
                    if (response.status == 'success'){
                      var segments = tier.segments.getSegments();
                      for (var i = 0; i< segments.length; i++){
                        if (segments[i].id == auxId){
                          segments[i].id = response.annotation_id;
                          container.setAttribute("data-selected", segments[i].id);
                        }
                      }
                    }
                  });
                }
              }(peaksInstance, url));
            }

            // Remove a segment, also remove it from the database
            var removeBtn  = container.querySelectorAll(".remove-point");
            if (removeBtn.length > 0) {
              removeBtn[0].addEventListener("click", function (tier, actionUrl) {
                return function(){
                  var segments = tier.segments.getSegments();
                  var currTime = tier.time.getCurrentTime();
                  for (var i = 0; i < segments.length; i++) {
                    if (currTime >= segments[i].startTime && currTime <= segments[i].endTime){
                      var id = segments[i].id;
                      callServer('remove', {annotation_id: id}, actionUrl, (function(remove_id){
                        return function(response){
                          if (response.status == 'success' ){
                            tier.segments.removeById(remove_id);
                          }
                        }
                      })(id));
                    }
                  }
                }
              }(peaksInstance, url));
            }
            
            var nameInp  = container.querySelectorAll(".name-txt");
            if (nameInp.length > 0) {
              nameInp[0].oninput = (function(tier){
                return function(event) {

                  for (var i = 0; i < delayedTextEdit.length; i++) {
                    window.clearTimeout(delayedTextEdit[i]);
                    delayedTextEdit.splice(i, 1);
                  }
                  segment = container.getAttribute('data-selected');
                  segments = tier.segments.getSegments();
                  if (segment) {
                    for (var i = 0; i < segments.length; i++) {
                      if (segments[i].id == segment){
                        segments[i].labelText = this.value;
                        segment = segments[i];
                        segment.annotation_id = segments[i].id;
                      }
                    }
                    delayedTextEdit.push(setTimeout((function(url, segment){
                      return function(){  
                        callServer('edit', segment, url, function(response){});
                      }
                    })(url, segment), 1000));
                  }
                }
              })(peaksInstance);
              nameInp[0].onpropertychange = nameInp[0].oninput; // for IE8
            
            }
          }
        })(peaks);
      </script>
{% endblock %}
</html>
