{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{% block meta_description %}{% endblock %}">

    <title>{% block title %}{% endblock %}</title>
    <style>
      #titles {
        font-family: 'Helvetica neue', Helvetica, Arial, sans-serif;
      }

      #titles, [class*="waveform-visualiser"] {
        margin: 24px auto;
        width: 1000px;
      }

      [class*="waveform-visualiser"] [class*="-container"] {
        box-shadow: 3px 3px 20px #919191;
        margin: 0 0 24px 0;
        -moz-box-shadow: 3px 3px 20px #919191;
        -webkit-box-shadow: 3px 3px 20px #919191;
        line-height: 0;
      }

      .overview-container {
        height: 85px;
      }

      #demo-controls {
        margin: 0 auto 24px auto;
        width: 1000px;
      }

      #demo-controls > * {
        vertical-align: middle;
      }

      #demo-controls button {
        background: #fff;
        border: 1px solid #919191;
        cursor: pointer;
      }
      .waveform-visualiser-container:not(.last) .overview-container{
        display: none;
      }
    </style>
 
</head>

<body>


<ul>
    <li><p> Annotation page for sound:</p></li>
    {{sound.filename }}
</ul>

  <script src="{% static 'node_modules/peaks.js/peaks.js' %}"></script>

  <div id="titles">
    {% for tier in sound.exercise.tiers.all %}
    <div class='tier' data-waveform='{{ MEDIA_URL }}{{sound.waveform_data }}' data-segments='{{tier.id}}'>
      <div class="waveform-visualiser-container {% if forloop.last %}last{% endif %}"></div>
      <button class="add-segment">Add a Segment to Tier</button>
      <button class="add-point">Add a Point to Tier</button>
      <button class="remove-point">Remove Segment</button>
    </div>
    {% endfor %}
      
      <div id="demo-controls">
        <audio controls=controls>
          <source src="{{ MEDIA_URL }}{{ sound.filename }}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
     </div>

      <script>
        (function(Peaks){
          var tiers = document.getElementsByClassName('tier');
          for (var i = 0; i < tiers.length; i++) {
            var container = tiers[i];
            
            var options = {
              container: container.getElementsByClassName('waveform-visualiser-container')[0], 
              mediaElement: document.querySelector('audio'),
              dataUri: {
                arraybuffer: container.getAttribute('data-waveform'),
              },
              height: 120,
              keyboard: false
            };

            var peaksInstance = Peaks.init(options);


            container.getElementsByClassName("add-segment")[0].addEventListener("click", function (tier) {
              return function(){
                tier.segments.add({
                  startTime: tier.time.getCurrentTime(),
                  endTime: tier.time.getCurrentTime() + 1,
                  editable: true
                });
              }
            }(peaksInstance));

            container.getElementsByClassName("add-point")[0].addEventListener("click", function (tier) {
              return function(){
                tier.points.add({
                  timestamp: tier.time.getCurrentTime(),
                  editable: true
                });
              }
            }(peaksInstance));
          
            container.getElementsByClassName("remove-point")[0].addEventListener("click", function (tier) {
              return function(){
                var segments = tier.segments.getSegments();
                console.log(segments);
                var currTime = tier.time.getCurrentTime();
                for (var i = 0; i < segments.length; i++) {
                  if (currTime >= segments[i].startTime && currTime <= segments[i].endTime){
                    tier.segments.removeByTime(segments[i].startTime);
                  }
                }
              }
            }(peaksInstance));
          }
        })(peaks);
      </script>
</body>
</html>
